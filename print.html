<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Shepherd</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="intro.html">Service Overview</a></li><li class="chapter-item affix "><li class="part-title">Docs</li><li class="chapter-item "><a href="quickStart.html"><strong aria-hidden="true">1.</strong> Quick Start</a></li><li class="chapter-item "><a href="metrics.html"><strong aria-hidden="true">2.</strong> Metrics</a></li><li class="chapter-item "><a href="operations/index.html"><strong aria-hidden="true">3.</strong> Operations and Runbooks</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="operations/auth.html"><strong aria-hidden="true">3.1.</strong> Authentication and Authorization</a></li><li class="chapter-item "><a href="operations/addAdvertisers.html"><strong aria-hidden="true">3.2.</strong> Add Advertisers</a></li><li class="chapter-item "><a href="operations/addAdvertiserPaths.html"><strong aria-hidden="true">3.3.</strong> Add Advertiser Paths</a></li><li class="chapter-item "><a href="operations/addPartners.html"><strong aria-hidden="true">3.4.</strong> Add Partners</a></li><li class="chapter-item "><a href="operations/createSovAllocations.html"><strong aria-hidden="true">3.5.</strong> Create SOV Allocations</a></li><li class="chapter-item "><a href="operations/createPublishSnapshots.html"><strong aria-hidden="true">3.6.</strong> Create and Publish Snapshots</a></li><li class="chapter-item "><a href="operations/rollback.html"><strong aria-hidden="true">3.7.</strong> Rollback</a></li><li class="chapter-item "><a href="operations/recoveryScript.html"><strong aria-hidden="true">3.8.</strong> Recover Snapshot</a></li><li class="chapter-item "><a href="operations/syncBoostrData.html"><strong aria-hidden="true">3.9.</strong> Sync Data from Boostr</a></li><li class="chapter-item "><a href="operations/syncBoostrDataCron.html"><strong aria-hidden="true">3.10.</strong> Sync Data from Boostr Cron Job</a></li></ol></li><li class="chapter-item "><li class="part-title">ADR</li><li class="chapter-item "><a href="adr/0000-metrics-client-for-shepherd.html"><strong aria-hidden="true">4.</strong> Shepherd Metrics</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Shepherd</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="contextual-services-shepherd"><a class="header" href="#contextual-services-shepherd">Contextual Services Shepherd</a></h1>
<h2 id="service-overview"><a class="header" href="#service-overview">Service Overview</a></h2>
<p>Shepherd is a Django application that allows users to make changes to Contile's advertising settings without redeploying Contile.
The settings managed here can be changed at runtime, eliminating the need for deployments of the services that use it.</p>
<p>Within Shepherd, users can make changes to Advertising Partners.
A given Partner can have multiple advertisers in numerous geolocations, each with their own distinct domain.
Users can also define partner allocation percentages for each tile position.
This means that given each Contile tile position, you can set the percentage of impressions that will show from each partner.</p>
<p>Once changes have been made and the user is ready to have these changes be effective in production, a user can create a “Snapshot.”
This records the settings and its values at that given point in time in the form of JSON.
Once published, Shepherd uploads a JSON file to Google Cloud Storage.
Contile will then pick up these changes in one of its 5 minute periodic check of the Google Cloud Storage bucket for an updated json file.</p>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<pre class="mermaid">%%{init: {'theme':'dark'}}%%
flowchart
    AdopsUser[\fa:fa-user AdOps User/] --&gt; |Update allocation &amp;&lt;br/&gt;settings snapshots| Shep(Shepherd) --&gt; DB[(Postgres DB)]
    Shep --&gt; |Validated JSON snapshot&lt;br/&gt;sent to GC bucket for access.| GCP[Google Cloud JSON]
    GCP -..- |Periodic sync for&lt;br/&gt;tile information| Contile(Contile)
    Contile --&gt;|API request to get tiles| Firefox{Firefox}
subgraph Firefox[fa:fa-firefox Firefox]
        Tab[New Tab] 
end

Tab --&gt; |Display advertising&lt;br/&gt;tiles in new tab| FirefoxUser[\fa:fa-user Firefox User/]
FirefoxUser[\fa:fa-user Firefox User/]
</pre>
<h2 id="datastores"><a class="header" href="#datastores">Datastores</a></h2>
<p>Shepherd's main datastore is a Postgres database that stores all partners, advertisers and snapshots.</p>
<p>All snapshots are uploaded as a JSON file to a Google Cloud bucket.
A pre-defined JSON schema validates the snapshot output prior to sending the snapshot to Google Cloud.
From there, Contile accesses the settings from the uploaded JSON file to serve Firefox users the correct advertising tiles in each new tab.</p>
<h2 id="shepherd-service-urls"><a class="header" href="#shepherd-service-urls">Shepherd Service URLs:</a></h2>
<p>Stage: https://shepherd.stage.ads.nonprod.webservices.mozgcp.net/admin/</p>
<p>Prod: https://shepherd.services.mozilla.com/admin/</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="quick-start-development-guide"><a class="header" href="#quick-start-development-guide">Quick Start Development Guide</a></h1>
<p>Shepherd is a grab-bag of Ad Operations tools, and currently consists of</p>
<ul>
<li><code>consvc_shepherd</code>: A full-stack Python Django app, as well as a json REST API</li>
<li><code>contile</code>: A Python Django app</li>
<li><code>ad-ops-dashboard</code>: A Node/Typescript React app, backed by the <code>consvc_shepherd</code> REST API</li>
</ul>
<h2 id="python-setup"><a class="header" href="#python-setup">Python setup</a></h2>
<p>To use consvc-shepherd, you'll need a Python 3.11 development environment with Poetry installed and Docker.</p>
<p>It is recommended to use <code>pyenv</code> and the <code>pyenv-virtualenv</code> plugin for your virtual environment.</p>
<ol>
<li>
<p>Install <code>pyenv</code> using the <a href="https://github.com/pyenv/pyenv#installation">latest documentation</a> for your platform.</p>
</li>
<li>
<p>Follow the instructions to install the <code>pyenv-virtualenv</code> plugin.
See the <a href="https://github.com/pyenv/pyenv-virtualenv">pyenv-virtualenv</a> documentation.</p>
</li>
<li>
<p>Ensure you've added <code>pyenv</code> and <code>pyenv-virtualenv</code> to your <code>PATH</code>:</p>
<p>Ex:</p>
<pre><code class="language-shell">export PATH=&quot;$HOME/.pyenv/bin:$PATH&quot;
eval &quot;$(pyenv init -)&quot;
eval &quot;$(pyenv virtualenv-init -)&quot;
</code></pre>
<p>To run consvc-shepherd, you'll need to specify some minimal configurations.
Use the existing <code>.env.example</code> and copy it to <code>.env</code>.</p>
<p>You'll want to make sure the environment variables in the <code>.env</code> file match your database setup, configuring the database name, user, host, and password.</p>
<p>It should appear as follows:</p>
<pre><code class="language-shell">$ cp .env.example .env

# Variables to set in file
DEBUG=true
SECRET_KEY=keyboard-mash
DB_NAME=postgres
DB_USER=postgres
DB_HOST=db
DB_PASS=postgres
</code></pre>
</li>
<li>
<p>Set up and enable your virtual environment:</p>
<pre><code class="language-shell"># pyenv version install
$ pyenv install 3.11

# pyenv virtualenv
$ pyenv virtualenv 3.11 shepherd # or whatever project name you like.
$ pyenv local shepherd # enables virtual env when you enter directory.
</code></pre>
</li>
<li>
<p>Install your dependencies:</p>
<pre><code class="language-shell">$ pip install poetry
$ poetry install
</code></pre>
</li>
<li>
<p><a href="https://docs.docker.com/engine/install/">Install Docker</a>, if not already installed.</p>
</li>
<li>
<p>Build the Docker image and start the container:</p>
<pre><code class="language-shell">docker compose up --build
</code></pre>
<p>The application will then be accessible at the following url: <a href="http://0.0.0.0:7001/">http://0.0.0.0:7001/</a>. The admin panel is available at <a href="http://0.0.0.0:7001/admin">http://0.0.0.0:7001/admin</a>.</p>
</li>
<li>
<p>Create database migrations and run migrations.</p>
<p>You may have to do this periodically as you modify or create models. Shell in as above and run the following commands:</p>
<pre><code class="language-shell">docker exec -it consvc-shepherd-app-1 bash # can also be run with `make debug`
python manage.py makemigrations
python manage.py migrate
</code></pre>
</li>
<li>
<p>Connect to the DB with <code>psql</code>.</p>
<p>While the Django Admin interface at <code>/admin</code> shows all the data in our DB in a human readable way, it may sometimes be
helpful to connect directly to the Shepherd DB while developing.</p>
<p><strong>Note</strong>: The values for the DB user and DB name come from the <code>.env</code> file.</p>
<pre><code class="language-shell">docker exec -it consvc-shepherd-db-1 psql -U postgres postgres
</code></pre>
</li>
<li>
<p>Seed Shepherd DB with random test data.</p>
<p>Shell into the <code>consvc-shepherd-app-1</code> container as mentioned above and run the following command:</p>
<pre><code class="language-shell">python manage.py seed
</code></pre>
<p>The script will output a success message once the database has been seeded:</p>
<pre><code class="language-shell">Successfully seeded the database with random data
</code></pre>
<p>Shell into <code>psql</code> and describe any of the DB tables (see example below), you should see that it contains some random data. Alternatively, you can look at the data by accessing the admin console at <a href="http://0.0.0.0:7001/admin">http://0.0.0.0:7001/admin</a>.</p>
<pre><code class="language-shell">SELECT * FROM consvc_shepherd_deliveredflight;
</code></pre>
</li>
<li>
<p>Import Boostr Deals and Products.</p>
<p>If you're working with the AdOps dashboard, you may want to pull in Boostr Deals and Products.</p>
<p>First, make sure you have the Boostr API credentials set in your <code>.env</code> file. You can find them in 1Password.</p>
<pre><code class="language-shell">BOOSTR_API_EMAIL=find-me-in-1password@mozilla.com
BOOSTR_API_PASS=i-am-in-1password-too
</code></pre>
<p>Then, run the script:</p>
<pre><code class="language-shell">docker exec -it consvc-shepherd-app-1 bash # can also be run with `make debug`
python manage.py sync_boostr_data https://app.boostr.com/api
</code></pre>
</li>
</ol>
<h2 id="nodetypescript-setup"><a class="header" href="#nodetypescript-setup">Node/Typescript setup</a></h2>
<p>To develop on the ad-ops-dashboard app, you'll need <code>node</code> and <code>npm</code> installed.</p>
<p>It is recommended to use a node version manager to allow for multiple <code>node</code>s on your system</p>
<ol>
<li>
<p>Install a node version manager. <a href="https://github.com/nvm-sh/nvm">nvm</a> is a great
choice if you're developing on a macOS with a POSIX-compliant shell.</p>
</li>
<li>
<p><code>cd ad-ops-dashboard</code></p>
</li>
<li>
<p>Install the <code>node</code> version specified in <code>ad-ops-dashboard/.nvmrc</code>:</p>
<pre><code class="language-shell">$ nvm install
</code></pre>
</li>
<li>
<p>Install <code>ad-ops-dashboard</code> app's dependencies:</p>
<pre><code class="language-shell">$ npm install
</code></pre>
</li>
<li>
<p>Set up the <code>ad-ops-dashboard</code> environment:</p>
<pre><code class="language-shell">$ cp .env.example .env
</code></pre>
</li>
<li>
<p>Spin up the <code>ad-ops-dashboard</code> app and REST api together:</p>
<pre><code class="language-shell">$ cd ..
$ docker-compose up --build
</code></pre>
<p>(You can also run the <code>ad-ops-dashboard</code> without the API via <code>npm run dev</code> from <code>./ad-ops-dashboard</code>)</p>
</li>
<li>
<p>Visit the home page at http://0.0.0.0:5173/</p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="shepherd-metrics"><a class="header" href="#shepherd-metrics">Shepherd Metrics</a></h1>
<p>This documentation describes the statsd-style metrics emitted by consvc_shepherd.</p>
<h2 id="metrics"><a class="header" href="#metrics">Metrics</a></h2>
<p>consvc_shepherd uses <a href="https://markus.readthedocs.io/en/latest/index.html" title="Markus documentation">markus</a> (metrics client) to emit statsd-style metrics like
counters, gauges, and timers. We use the <a href="https://docs.datadoghq.com/developers/dogstatsd" title="dogstatsd documentation">datadog extensions</a>, which
include tags for metrics. In the production instance of Shepherd, metrics are emitted as
<a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol">UDP packets</a>, collected by a local <a href="https://docs.influxdata.com/telegraf">telegraf</a> forwarder, and
stored in <a href="https://docs.influxdata.com/influxdb/latest/reference/key-concepts/">influxdb</a>. In development, metrics are disabled by
default, but there is a way described below to view metrics in development via <code>nc</code>.</p>
<h2 id="telegraf"><a class="header" href="#telegraf">Telegraf</a></h2>
<p><a href="https://github.com/influxdata/telegraf">Telegraf</a> is a plugin-driven server agent written by the team at <a href="https://influxdata.com">InfluxData</a> for collecting &amp; reporting metrics. To understand the 
configuration for Mozilla services, please view the documentation in <a href="https://github.com/mozilla-services/cloudops-infra/tree/master/libs/influx/k8s/charts/telegraf">cloudops-infra</a>.</p>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>Configuration is controlled by the following environment variables:</p>
<ul>
<li><code>DJANGO_STATSD_ENABLED</code> (default <code>False</code>) : Enables / disables emitting metrics to a
statsd server</li>
<li><code>STATSD_DEBUG</code> (default <code>False</code>) : Enables / disables metrics logging</li>
<li><code>STATSD_ENABLED</code> (default <code>False</code>) : Enables metrics, <code>True</code> if either
<code>DJANGO_STATSD_ENABLED</code> or <code>STATSD_DEBUG</code> are <code>True</code></li>
<li><code>STATSD_HOST</code> (default <code>&quot;127.0.0.1&quot;</code>) : statsd server IP</li>
<li><code>STATSD_PORT</code> (default <code>8125</code>) : statsd server port</li>
<li><code>STATSD_PREFIX</code> (default <code>&quot;shepherd&quot;</code>) : prefix definition for all metrics in project.
Dashes (and some other values) are converted to periods.</li>
</ul>
<p>With the defaults <code>DJANGO_STATSD_ENABLED=False</code> and <code>STATSD_DEBUG=False</code>, no metrics
are emitted. Ensure that in the deployed production instance of Shepherd, the following values are set accordingly:
<code>DJANGO_STATSD_ENABLED=True</code> and <code>STATSD_DEBUG=False</code>. This is so metrics are emitted but do not appear in logs.</p>
<p>Shepherd runs on k8s, the app is defined in a helm chart that lives in the <code>webservices-infra</code> repo. Environment variables are set in the <code>config</code> dictionary in shepherd's helm chart's values files and rendered into a configmap during deployment. Additionally, secret values (that are mapped to k8s secrets via <code>external-secrets</code>) are set in Google Secret Manager.</p>
<h2 id="development"><a class="header" href="#development">Development</a></h2>
<p>By default, metrics are disabled in development. They must be enabled via an
environment variable or in the <code>.env</code> file. Set <code>STATSD_DEBUG</code> to <code>True</code>.</p>
<p>Metrics are set, incremented, and controlled by utility wrapper methods that are defined in the <code>ShepherdMetrics</code> class contained in the <a href="../consvc_shepherd/utils.py">consvc_shepherd/utils.py</a> module:</p>
<ul>
<li><code>time_if_enabled(name)</code></li>
<li><code>incr_if_enabled(name, value=1, tags=None)</code></li>
<li><code>histogram_if_enabled(name, value, tags=None)</code></li>
<li><code>gauge_if_enabled(name, value, tags=None)</code></li>
</ul>
<p>Simply instantiate a <code>ShepherdMetrics</code> class in your module, passing to it the <code>thing</code> parameter as defined in the <code>markus</code> docs, which defines the prefix keys that will be generated. Generally, <code>thing</code>  should be set to the module name and question, which you can define explicitly or by passing  <code>__name__</code>. Instantiating this class calls <code>markus.get_metrics()</code> and returns <code>markus.main.MetricsInterface</code> under the hood, on which all these methods are called. This metrics class decouples the logic from direct calls to <code>markus.main.MetricsInterface</code> instances.</p>
<pre><code class="language-python">from consvc_shepherd.utils import ShepherdMetrics

metrics = ShepherdMetrics(&quot;shepherd&quot;)

metrics.incr_if_enabled(&quot;publication.success&quot;)
</code></pre>
<p>With <code>DJANGO_STATSD_ENABLED=True</code>, metrics are sent to the server identified by
<code>STATSD_HOST</code> and <code>STATSD_PORT</code>, using the <a href="https://markus.readthedocs.io/en/latest/backends.html#datadog-metrics">DatadogMetrics
backend</a>. These are sent as UDP packets, which means
they are silently dropped if there is no server to receive them. In local
development on macOS, you can emulate a <code>statsd</code> server and see the metrics with:</p>
<pre><code class="language-sh">nc -lu localhost 8125
</code></pre>
<p>With <code>STATSD_DEBUG=True</code>, metrics are sent to the <code>markus</code> log using the
<a href="https://markus.readthedocs.io/en/latest/backends.html#logging-metrics">LoggingMetrics backend</a>. They are displayed along
with other logs like <code>request.summary</code> from that service.</p>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<p>When writing tests for metrics, they can be enabled via
<a href="https://docs.djangoproject.com/en/4.2/topics/testing/tools/#django.test.override_settings">override_settings</a>, and captured for test assertions with
<a href="https://markus.readthedocs.io/en/latest/testing.html">MetricsMock</a>. For example:</p>
<pre><code class="language-python">from django.test import TestCase, override_settings

from markus.testing import MetricsMock

from shepherd.utils import incr_if_enabled


def code_that_emits_metric() -&gt; int:
    incr_if_enabled(&quot;code_called&quot;)
    return 1


class CodeTest(TestCase):
    @override_settings(STATSD_ENABLED=True)
    def test_code(self) -&gt; None:
        with MetricsMock() as mm:
            assert code_that_emits_metric() == 1

        mm.assert_incr_once(&quot;shepherd.code_called&quot;)
</code></pre>
<p>When testing, note that the <code>STATSD_PREFIX</code> (default <code>&quot;shepherd&quot;</code>) is
in the emitted metric name, so in this example, the test is looking for
<code>&quot;shepherd.code_called&quot;</code>, not <code>&quot;code_called&quot;</code>.</p>
<p><code>MetricsMock</code> has other useful helper methods, such as
<a href="https://markus.readthedocs.io/en/latest/testing.html#markus.testing.MetricsMock.print_records">print_records()</a> to see all captured metrics. This can help
when determining what metrics code is emitting.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="operations-and-runbooks"><a class="header" href="#operations-and-runbooks">Operations and Runbooks</a></h1>
<p>This is where we put all our operational documentation.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="authorization-and-access-requirements"><a class="header" href="#authorization-and-access-requirements">Authorization and Access Requirements</a></h2>
<p>There are a number of authorization and access requirements needed to be able to access Shepherd.</p>
<ol>
<li>Shepherd Google Access Group
<ul>
<li>Not being part of the group would result in a Google access denied warning when attempting visiting any of the Shepherd URLs.</li>
</ul>
</li>
<li>Shepherd Django Roles
<ul>
<li>Not having these roles would result in being presented the &quot;Django Administration&quot; login page.</li>
<li>You can create a new admin user though the Users panel in Django Admin.</li>
</ul>
</li>
</ol>
<p><em>For access please ask someone on the Engineering Team. For engineers, ask to be given superuser privileges. For ad operations ask to be added to the 'AdOps' Django group</em></p>
<h2 id="shepherd-urls"><a class="header" href="#shepherd-urls">Shepherd URLs:</a></h2>
<ul>
<li>Stage: https://shepherd.stage.ads.nonprod.webservices.mozgcp.net/admin/</li>
<li>Prod: https://shepherd.services.mozilla.com/admin/</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="adding-advertisers"><a class="header" href="#adding-advertisers">Adding Advertisers</a></h2>
<p>This is restricted to the Content Discovery Engineering team or AdOps.</p>
<ol>
<li>From the main admin page, under the Contile subsection, click the add button next to Advertisers.</li>
<li>Enter the name of the advertiser and select the matching partner from the dropdown.  Currently all advertisers configured in Shepherd have the &quot;amp&quot; partner specified since &quot;moz-sales&quot; ads are served through Pocket-Proxy.</li>
<li>Add Urls associated with this advertiser. Each Url will have a country, domain, and path. Urls can be from different countries and domains (e.g. Amazon could have amazon.de in Germany and amazon.ca in Canada).
<ol>
<li>Select the Geolocation from the dropdown to select the country for the advertiser.</li>
<li>Enter the advertising root domain, like www.mozilla.com, with no trailing forward slash.</li>
<li>Enter the path, which at a minimum must be a /.</li>
<li>Select the radio button for exact or prefix matching.</li>
</ol>
</li>
<li>Click Save to persist the advertiser settings. Repeat 1-4 for each new advertiser.</li>
<li>Proceed to <a href="operations/./createPublishSnapshots.html">Creating and Publishing a Snapshot</a> to publish the updates to make them live in production.</li>
<li>Apply the same changes in staging</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h2 id="adding-advertiser-paths"><a class="header" href="#adding-advertiser-paths">Adding Advertiser Paths</a></h2>
<p>This is restricted to the Content Discovery Engineering team or AdOps.</p>
<ol>
<li>From the main admin page, under the Contile subsection, click the Advertisers link to see the list of existing advertisers.</li>
<li>Find the advertiser in the list and click on that row.</li>
<li>Add new Urls associated with this advertiser. Each Url will have a country, domain, and path. Urls can be from different countries and domains (e.g. Amazon could have amazon.de in Germany and amazon.ca in Canada). Be careful not to add duplicate paths, as this will cause the snapshot publish step will fail.
<ol>
<li>Select the Geolocation from the dropdown to select the country for the advertiser.</li>
<li>Enter the advertising root domain, like www.mozilla.com, with no trailing forward slash.</li>
<li>Enter the path, which at a minimum must be a /.</li>
<li>Select the radio button for exact or prefix matching.</li>
</ol>
</li>
<li>Click Save to persist the advertiser settings. Repeat 1-4 for each new advertiser.</li>
<li>Proceed to <a href="operations/./createPublishSnapshots.html">Creating and Publishing a Snapshot</a> to publish the updates to make them live in production.</li>
<li>Apply the same changes in staging</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h2 id="adding-partners"><a class="header" href="#adding-partners">Adding Partners</a></h2>
<p>This is restricted to the Content Discovery Engineering team or AdOps.</p>
<p>From the main admin page, under the Contile subsection, click the add button next to Advertisers.
Type in name of partner and click save.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="create-and-manage-sov-share-of-voice-allocation-settings"><a class="header" href="#create-and-manage-sov-share-of-voice-allocation-settings">Create and Manage SOV (Share-of-Voice) Allocation Settings</a></h2>
<p>This is restricted to the Content Discovery Engineering team or AdOps.</p>
<ol>
<li>a. From the main CONSVC_SHEPHERD subsection in the admin panel, click the add button next to Allocation settings. 
b. Using the main UI, click  '% Allocation' then click 'Add New Position'</li>
<li>Enter the numeric position of the tile in the Position field. If editing an existing allocation, simply click on the tile number you want to edit.</li>
<li>Select the matching partner and enter the SOV allocation percentage from 0 - 100%.</li>
<li>If adding an additional position, select 'Add another Partner' (admin) or 'Add Partner' (UI) and enter that Partner's allocation percentage.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h2 id="creating-and-publishing-a-snapshot"><a class="header" href="#creating-and-publishing-a-snapshot">Creating and Publishing a Snapshot</a></h2>
<p>Click the Add buttons for Settings or Allocation settings snapshots under CONSVC_SHEPHERD:</p>
<ol>
<li>Input a name 
<ul>
<li>recommendation is to have the name relate to the changes done to the advertiser (ex. Added Advertiser X Y and Z or Added Black Friday URLs to X) The name has a 128 Character limit.</li>
</ul>
</li>
<li>Select settings type. At this time, this would be the Partner name. <em>NOTE</em>: <em>This only applies to settings snapshots, allocation snapshots do not have a type field.</em></li>
<li>Hit Save. A Snapshot has been saved. </li>
<li>To publish it, click the checkbox that corresponds to the snapshot. </li>
<li>Select “Publish Settings Snapshot” from the actions dropdown and click “Go”.
<ul>
<li>A green status bar should appear at the top of the page stating the snapshot has been published.</li>
</ul>
</li>
</ol>
<p><em>Note that Shepherd is unable to undo snapshots. 
If changes need to be undone, one would have to manually revert the advertiser information and create a new snapshot.
For complex reverts, please contact the engineering team.</em></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-rollback-changes"><a class="header" href="#how-to-rollback-changes">How to Rollback Changes</a></h1>
<p>Note: We use &quot;roll-forward&quot; strategy for rolling back changes in production.</p>
<ol>
<li>Depending on the severity of the problem, decide if this warrants
<a href="https://mozilla-hub.atlassian.net/wiki/spaces/MIR/overview">kicking off an incident</a>;</li>
<li>Identify the problematic commit and create a revert PR.
If it is the latest commit, you can revert the change with:
<pre><code>git revert HEAD~1
</code></pre>
</li>
<li>Create a revert PR and go through normal review process to merge PR.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h2 id="recover-snapshot"><a class="header" href="#recover-snapshot">Recover Snapshot</a></h2>
<p>The script is used as a last resort to revert data in Shepherd back to a specific snapshot.
You would need to:</p>
<ol>
<li>Log into Shepherd Admin as a superuser.</li>
<li>Delete the partner model instance which will also delete all its child instances.</li>
<li>Run <code>python3 main.py &lt;SHEPHERD URL&gt; &lt;PATH TO JSON FILE&gt; &lt;PATH TO FIREFOX PROFILE&gt;</code>
This will add advertisers and advertiser urls based on the values from the
json file you provide it.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sync-data-from-boostr-and-upsert-it-into-the-shepherd-db"><a class="header" href="#sync-data-from-boostr-and-upsert-it-into-the-shepherd-db">Sync data from Boostr and upsert it into the Shepherd DB</a></h1>
<p>Currently this is a Django admin command that can be manually run by <code>docker exec</code>-ing into a shepherd app container. This job is ran regularly by the Kubernetes cron schedule documented in <a href="operations/syncBoostrDataCron.html">SyncBoostrDataCron.md</a></p>
<h3 id="instructions-to-run"><a class="header" href="#instructions-to-run">Instructions to run</a></h3>
<ol>
<li>Find the credentials for the Boostr API in the 1Password vault</li>
<li>Set the credentials by copying .env.example to .env, and setting the BOOSTR_API_EMAIL and BOOSTR_API_PASS variables</li>
<li>Exec into the consvc-shepherd container:</li>
</ol>
<pre><code class="language-sh">make debug
</code></pre>
<ol start="4">
<li>Find the base url of the Boostr API that you want to hit. For production Boostr, this is &quot;https://app.boostr.com/api/&quot;.</li>
<li>Run the script, providing base url as a positional arg.</li>
</ol>
<pre><code class="language-sh">python manage.py sync_boostr_data https://app.boostr.com/api/
</code></pre>
<h3 id="optional-arguments"><a class="header" href="#optional-arguments">Optional arguments</a></h3>
<h4 id="--max-deal-pages"><a class="header" href="#--max-deal-pages">--max-deal-pages</a></h4>
<p>The script can take an optional named argument, <code>--max-deal-pages</code>, which will
set an upper limit on the number of pages of deals that we fetch from the API.</p>
<p>By default, the script will fetch pages of 300 deals at a time until it
receives an empty response from the Boostr API. And if it never receives an
empty response, the script will stop fetching after 50 deal pages by default
(<code>MAX_DEAL_PAGES_DEFAULT</code>).</p>
<p>We currently have about 14 pages of deals (at 300 deals per page) in our
production Boostr account, so the default value of 50 gives us lots of overhead,
but this parameter allows us to invoke the script with a custom value for the
upper limit on deal pages.</p>
<p>Usage:</p>
<pre><code class="language-sh">python manage.py sync_boostr_data https://app.boostr.com/api --max-deal-pages 15
</code></pre>
<h3 id="debug-logs"><a class="header" href="#debug-logs">Debug logs</a></h3>
<p>The script takes several minutes to run. To get more detailed logging on which
specific deals and products are being saved, run with <code>SHEPHERD_ENV=DEBUG</code></p>
<pre><code class="language-shell">SHEPHERD_ENV=DEBUG python manage.py sync_boostr_data
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="boostr-data-sync-cron"><a class="header" href="#boostr-data-sync-cron">Boostr Data Sync Cron</a></h1>
<p>The Boostr data sync process documented in the <a href="operations/syncBoostrData.html">SyncBoostrData.md</a> document is orchestrated by a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/">Kubernetetes Cronjob</a> that is maintained in the <a href="https://github.com/mozilla-it/webservices-infra/tree/main/ads/k8s/shepherd">shepherd chart</a> in the <a href="https://github.com/mozilla-it/webservices-infra/tree/main">webservices-infra</a> repo. </p>
<h3 id="how-it-runs"><a class="header" href="#how-it-runs">How it runs</a></h3>
<p>The CronJob spins up a new pod on a configurable schedule using the latest container image of the Shepherd application. It then triggers the 
<a href="operations/consvc_shepherd/management/commands/sync_boostr_data.py">sync_boostr_data.py</a> script within the pod. Refer to <a href="operations/syncBoostrDataCron.html">SyncBoostrData.md</a> to understand more about the inner workings of the script.</p>
<h3 id="a-note-on-secrets"><a class="header" href="#a-note-on-secrets">A Note on Secrets</a></h3>
<p>Secrets such as the email and password used to access the Boostr API are stored in 1Pass. However, since k8s cronjobs are ultimately k8s pods running a container image, we follow best practices and mount environment variables and secrets to the resulting pods via k8s configmaps &amp; secrets. In this context, non-sensitive key-value pairs are deployed using a configmap (defined in the [shepherd chart]'s values files), sensitive values are deployed using a secret (secrets are defined in Google Secret Manager secrets in tenant projects and synced into tenant namespaces using the <code>external-secrets operator</code>, see <a href="https://mozilla-hub.atlassian.net/wiki/x/cQaqAQ">here</a> for more details).</p>
<p>The process SRE has recommended for storing/using secrets is as follows:</p>
<ol>
<li>Secrets should be stored in 1password for use by individuals (e.g. the dev team)</li>
<li>GCPv2 tenant projects make use of Google Secret Manager to distribute secrets to deployments. Helm charts that are deployed to tenant namespaces should define an external-secret that syncs secret data down to k8s secrets from Google Secret Manager Secrets. <a href="https://mozilla-hub.atlassian.net/wiki/x/cQaqAQ">see</a></li>
<li>Tenant developers &amp; admins can update Google Secret Manager secrets as necessary. Please follow the process defined in the previous step to do so.</li>
<li>As a result of the above, the values for the secret variables in #2 are set and available in the resource (pod / container) as environment variables.</li>
</ol>
<h3 id="debugging-troubleshooting-and-viewing-logs"><a class="header" href="#debugging-troubleshooting-and-viewing-logs">Debugging, troubleshooting and viewing logs</a></h3>
<p>To view logs, use Logs Explorer. All GKE pod logs are forwarded to tenant projects for tenant viewers, developers and admins to look at. To filter for boostr data sync's logs explicitly, set the following filter:</p>
<pre><code>labels.&quot;k8s-pod/app_kubernetes_io/component&quot; =~ &quot;^shepherd-cron-boostr-sync&quot;
</code></pre>
<p>The following links should lead to the right place:</p>
<ul>
<li><a href="https://cloudlogging.app.goo.gl/VPZZgGHdFPvzVBzB7">prod/prod</a></li>
<li><a href="https://cloudlogging.app.goo.gl/qT3JmY6bcLw54Cwi9">nonprod/stage</a></li>
</ul>
<p>As an alternative, <code>gcloud logging read</code> can be used to retrieve logs via the CLI (follow <a href="https://cloud.google.com/sdk/gcloud/reference/logging/read">this guide</a>, to get more details). It is possible to retrieve logs via <code>kubectl</code> as well, setup requires some additional steps, though, since we're running on private clusters that need to be accessed via jumphosts(more info can be found <a href="https://mozilla-hub.atlassian.net/wiki/x/TAiqAQ">here</a>).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="statsd-client-library-for-shepherd"><a class="header" href="#statsd-client-library-for-shepherd">StatsD Client Library for Shepherd</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Deciders: <a href="https://github.com/taddes">@taddes</a>, <a href="https://github.com/tiftran">@tiftran</a>, <a href="https://github.com/ncloudioj">@ncloudioj</a></li>
<li>Date: 2023-05-30</li>
</ul>
<h2 id="context-and-problem-statement"><a class="header" href="#context-and-problem-statement">Context and Problem Statement</a></h2>
<p>Shepherd is currently a minimal Django Admin application used to create and publish snapshots of advertiser settings of Sponsored Tiles. The recent expansion of the service through the Project Honeycomb: Share-of-Voice epic <a href="https://mozilla-hub.atlassian.net/browse/DISCO-2290">DISCO-2290</a> along with moving to a developer-driven Continuous Deployment model <a href="https://mozilla-hub.atlassian.net/browse/DISCO-2208">DISCO-2208</a> necessitated discussion around application metrics and observability. Up to this point, we did not have any information to analyze Shepherd's internal state pre or post deploy aside from automated testing and manual testing.</p>
<h2 id="decision-drivers"><a class="header" href="#decision-drivers">Decision Drivers</a></h2>
<ol>
<li>Easy to implement, provides necessary features. </li>
<li>Does not require excessive customization to Shepherd that hinders current/future development.</li>
<li>Works well with synchronous Python web frameworks (Shepherd is using Django).</li>
<li>Has precedent of effective usage (is used at Mozilla by other teams with more mature Django applications).</li>
<li>Good documentation, engagement, and maintenance with broader community.</li>
<li>Easy testing (plus if testing/mocking framework provided). </li>
<li>Fits into Rapid Release Model strategy — specifically, using the same libraries and frameworks across similarly shaped services owned by the same team.</li>
</ol>
<h2 id="considered-options"><a class="header" href="#considered-options">Considered Options</a></h2>
<ul>
<li>A. Markus <a href="https://pypi.org/project/markus/">PyPI</a></li>
<li>B. Prometheus <a href="https://pypi.org/project/prometheus-client/">PyPI</a></li>
<li>C. statsd (pystatsd) <a href="https://pypi.org/project/statsd/">PyPI</a></li>
<li>D. aiodogstatsd <a href="https://pypi.org/project/aiodogstatsd/">PyPI</a></li>
</ul>
<h2 id="decision-outcome"><a class="header" href="#decision-outcome">Decision Outcome</a></h2>
<p>Chosen option:</p>
<ul>
<li>A. Markus</li>
</ul>
<p>Markus essentially meets all our required needs with a number of significant features that provide great benefit. </p>
<p>Most StatsD libraries are not excessively complicated, in that the core functions of calling an increment, gauge, timer and histogram.  Markus matches this need with added flexibility, in that you can define tags and filters when calling a given metric and define backends.</p>
<p>Even though aiodogstatsd is used in Merino and we'd like to aim to use the same library across services, it is not the appropriate choice for Shepherd. We do not require asynchronous features. Since Merino runs on FastAPI, an asynchronous web-framework and Shepherd runs on Django, a synchronous web-framework, each respective choice is dictated by the architecture and service's needs. </p>
<p>As a side note, aiodogstatsd is harder to test and has significantly fewer features than Markus when testing is concerned. This could hamper maintenance and development efficiency. </p>
<p>Example:</p>
<p>To return a MetricsInterface instance (with a specified prefix):</p>
<pre><code class="language-python">get_metrics(&quot;shepherd&quot;)
markus.get_metrics(thing='', extra='', filters=None)
</code></pre>
<p><code>thing</code> is a prefix to use for keys 
<code>extra</code> adds bits to end of prefix
<code>filters</code>, list of filters to apply</p>
<p><strong><a href="https://markus.readthedocs.io/en/latest/backends.html">Backends</a></strong> - A significant feature Markus has over other libraries is the ability to define metrics backends. It comes with the <code>LoggingMetrics</code>, <code>LoggingRollupMetrics</code>, <code>StatsdMetrics</code>, <code>DatadogMetrics</code>, <code>CloudwatchMetrics</code> by default, handling numerous configuration optimizations. You can also define your own backend.</p>
<p>Example:</p>
<p>Define <code>markus.configure()</code> and append backends, passing backends parameter as list of dicts. Each dict defines a backend. Can do datadog and logger configs, for example.  Each backend has a class argument, options dict for configuration, filters list to apply to emitted metrics:</p>
<ol>
<li>Configure Markus’ backends using <code>markus.configure()</code>.</li>
<li>For each Python module or class or however you want to organize it, you use <code>markus.get_metrics()</code> to get a <code>markus.main.MetricsInterface</code>.</li>
<li>Use the various metrics reporting methods on the <code>markus.main.MetricsInterface</code>.</li>
</ol>
<pre><code class="language-python">import markus
from markus.filters import AddTagFilter

markus.configure([
    {
        &quot;class&quot;: &quot;markus.backends.logging.LoggingMetrics&quot;,
        &quot;options&quot;: {
            &quot;logger_name&quot;: &quot;markus&quot;,
            &quot;leader&quot;: &quot;METRICS&quot;,
        }
    }
])
</code></pre>
<p><strong><a href="https://markus.readthedocs.io/en/latest/filters.html">Filters</a></strong> - Markus lets you write filters to modify generated metrics on the fly. This allows infinite customization to drop or modify metric values before they are emitted.</p>
<pre><code class="language-python">class DebugFilter(MetricsFilter):
    def filter(self, record):
        if &quot;debug:true&quot; in record.tags:
            return
        return record
</code></pre>
<h3 id="positive-consequences"><a class="header" href="#positive-consequences">Positive Consequences</a></h3>
<ul>
<li>Quality of metrics customizations mean significant control of what metrics we want to emit.</li>
<li>Built-in DogStatsD through backend.</li>
<li>Lines up perfectly with our deployed infrastructure in Docker/Kubernetes (Telegraf &amp; InfluxDB)</li>
<li>High quality library and documentation mean an ease of development and maintenance.</li>
<li>Backend configuration and filters mean fine-tuning of our metrics.</li>
<li>Fast development time for minimal use cases.</li>
</ul>
<h3 id="negative-consequences"><a class="header" href="#negative-consequences">Negative Consequences</a></h3>
<ul>
<li>None that come to mind, there are other viable alternatives but Markus seems to fit our needs very well.</li>
<li>Possibly that Markus is a new and different library from say aiodogstatsd, which is used in Merino. However, that is an async library and it has several drabacks compared to Markus for our use case.</li>
</ul>
<h2 id="pros-and-cons-of-the-options"><a class="header" href="#pros-and-cons-of-the-options">Pros and Cons of the Options</a></h2>
<h3 id="markus"><a class="header" href="#markus">Markus</a></h3>
<p><a href="https://markus.readthedocs.io/en/latest/">Docs</a></p>
<p><a href="https://pypi.org/project/markus/">PyPI</a></p>
<p><a href="https://github.com/willkg/markus">GitHub Repo</a></p>
<h4 id="pros"><a class="header" href="#pros">Pros</a></h4>
<ul>
<li>Used by several teams managing robust and large Django apps (fx-private-relay, mdn, etc)</li>
<li>Very easy to use.</li>
<li>Allows configuration of multiple backends to process metrics emissions. </li>
<li>Filters for individual metrics.</li>
<li>Highly customizable. </li>
<li>Exceptional documentation with great examples.</li>
<li>Included test class for mocking metrics emissions, backends and pre-built assertions. Excellent testing docs.</li>
<li>Core maintainer a Mozillian (willkg)</li>
<li>Active maintenance and support.</li>
</ul>
<h4 id="cons"><a class="header" href="#cons">Cons</a></h4>
<ul>
<li>Different from other used libraries</li>
<li>Takes a little time to get up to speed, but still easy to understand.</li>
</ul>
<h3 id="prometheus"><a class="header" href="#prometheus">Prometheus</a></h3>
<p><a href="https://prometheus.io/">Docs</a></p>
<p><a href="https://pypi.org/project/prometheus-client/">PyPI</a></p>
<p><a href="https://github.com/prometheus/client_python">GitHub Repo</a></p>
<h4 id="pros-1"><a class="header" href="#pros-1">Pros</a></h4>
<ul>
<li>Widely used in Django community.</li>
<li>High quality documentation.</li>
<li>A lot of possible customization, especially for Django.</li>
</ul>
<h4 id="cons-1"><a class="header" href="#cons-1">Cons</a></h4>
<ul>
<li>Some Mozillians advised against usage due to difficulty to set up and maintain.</li>
<li>Cumbersome as you have to import each metric class individually to call.</li>
<li>An open-source monitoring solution that we as an organization are not using. Some vertical integration needed to get full benefit.</li>
<li>Supposedly some difficulty in configuring with our existing infrastructure.</li>
<li>A little bit too complicated for our use case.</li>
</ul>
<h3 id="statsd-pystatsd"><a class="header" href="#statsd-pystatsd">statsd (pystatsd)</a></h3>
<p><a href="https://statsd.readthedocs.io/en/latest/index.html">Docs</a></p>
<p><a href="https://pypi.org/project/statsd/">PyPI</a></p>
<p><a href="https://github.com/jsocol/pystatsd">GitHub Repo</a></p>
<h4 id="pros-2"><a class="header" href="#pros-2">Pros</a></h4>
<ul>
<li>Excellent documentation.</li>
<li>Good Django support and instructions for configuration.</li>
<li>Active community and contribution.</li>
<li>Basic, no frills.</li>
</ul>
<h4 id="cons-2"><a class="header" href="#cons-2">Cons</a></h4>
<ul>
<li>No testing framework, have to write totally custom tests without mocking or test classes built-in. </li>
<li>No provided backend configurations.</li>
<li>A bit too simplistic and lacking in features.</li>
<li>Somewhat cumbersome when dealing with specific customizations.</li>
</ul>
<h3 id="aiodogstatsd"><a class="header" href="#aiodogstatsd">aiodogstatsd</a></h3>
<p><a href="https://gr1n.github.io/aiodogstatsd/usage/">Docs</a></p>
<p><a href="https://pypi.org/project/aiodogstatsd/">PyPI</a></p>
<p><a href="https://github.com/Gr1N/aiodogstatsd">GitHub Repo</a></p>
<h4 id="pros-3"><a class="header" href="#pros-3">Pros</a></h4>
<ul>
<li>Already used in Merino.</li>
<li>Fairly self-evident implementation.</li>
</ul>
<h4 id="cons-3"><a class="header" href="#cons-3">Cons</a></h4>
<ul>
<li>Designed for asynchronous applications and Django is not an asynchronous app. Don't really require those features.</li>
<li>Uses port 9125 by default and differs from the default StatsD implementation (can be modified, of course).</li>
<li>Documentation is very scant, examples are limited.</li>
<li>Does not include a test class or framework, test documentation nonexistent.</li>
<li>Smaller team of maintainers and contributors. (last commit Dec 12, 2021).</li>
</ul>
<h2 id="links"><a class="header" href="#links">Links</a></h2>
<ul>
<li><a href="https://thenewstack.io/collecting-metrics-using-statsd-a-standard-for-real-time-monitoring/">Collecting Metrics Using StatsD, a Standard for Real-Time Monitoring </a></li>
<li><a href="https://github.com/statsd">Statsd - Original Protocol GitHub</a></li>
<li><a href="https://docs.datadoghq.com/developers/dogstatsd/?tab=hostagent">DogStatsD</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
