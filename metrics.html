<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Metrics - Shepherd</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="intro.html">Service Overview</a></li><li class="chapter-item affix "><li class="part-title">Docs</li><li class="chapter-item "><a href="intro.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item "><a href="quickStart.html"><strong aria-hidden="true">2.</strong> Quick Start</a></li><li class="chapter-item expanded "><a href="metrics.html" class="active"><strong aria-hidden="true">3.</strong> Metrics</a></li><li class="chapter-item "><a href="operations/index.html"><strong aria-hidden="true">4.</strong> Operations and Runbooks</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="operations/auth.html"><strong aria-hidden="true">4.1.</strong> Authentication and Authorization</a></li><li class="chapter-item "><a href="operations/addAdvertisers.html"><strong aria-hidden="true">4.2.</strong> Add Advertisers</a></li><li class="chapter-item "><a href="operations/addAdvertiserPaths.html"><strong aria-hidden="true">4.3.</strong> Add Advertiser Paths</a></li><li class="chapter-item "><a href="operations/addPartners.html"><strong aria-hidden="true">4.4.</strong> Add Partners</a></li><li class="chapter-item "><a href="operations/createSovAllocations.html"><strong aria-hidden="true">4.5.</strong> Create SOV Allocations</a></li><li class="chapter-item "><a href="operations/createPublishSnapshots.html"><strong aria-hidden="true">4.6.</strong> Create and Publish Snapshots</a></li><li class="chapter-item "><a href="operations/rollback.html"><strong aria-hidden="true">4.7.</strong> Rollback</a></li><li class="chapter-item "><a href="operations/recoveryScript.html"><strong aria-hidden="true">4.8.</strong> Recover Snapshot</a></li><li class="chapter-item "><a href="operations/syncBoostrData.html"><strong aria-hidden="true">4.9.</strong> Sync Data from Boostr</a></li><li class="chapter-item "><a href="operations/syncBoostrDataCron.html"><strong aria-hidden="true">4.10.</strong> Sync Data from Boostr Cron Job</a></li><li class="chapter-item "><a href="operations/syncBigQueryData.html"><strong aria-hidden="true">4.11.</strong> Sync Data from BigQuery</a></li><li class="chapter-item "><a href="operations/syncBigQueryDataCron.html"><strong aria-hidden="true">4.12.</strong> Sync Data from BigQuery Cron Job</a></li></ol></li><li class="chapter-item "><li class="part-title">ADR</li><li class="chapter-item "><a href="adr/0000-metrics-client-for-shepherd.html"><strong aria-hidden="true">5.</strong> Shepherd Metrics</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Shepherd</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="shepherd-metrics"><a class="header" href="#shepherd-metrics">Shepherd Metrics</a></h1>
<p>This documentation describes the statsd-style metrics emitted by consvc_shepherd.</p>
<h2 id="metrics"><a class="header" href="#metrics">Metrics</a></h2>
<p>consvc_shepherd uses <a href="https://markus.readthedocs.io/en/latest/index.html" title="Markus documentation">markus</a> (metrics client) to emit statsd-style metrics like
counters, gauges, and timers. We use the <a href="https://docs.datadoghq.com/developers/dogstatsd" title="dogstatsd documentation">datadog extensions</a>, which
include tags for metrics. In the production instance of Shepherd, metrics are emitted as
<a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol">UDP packets</a>, collected by a local <a href="https://docs.influxdata.com/telegraf">telegraf</a> forwarder, and
stored in <a href="https://docs.influxdata.com/influxdb/latest/reference/key-concepts/">influxdb</a>. In development, metrics are disabled by
default, but there is a way described below to view metrics in development via <code>nc</code>.</p>
<h2 id="telegraf"><a class="header" href="#telegraf">Telegraf</a></h2>
<p><a href="https://github.com/influxdata/telegraf">Telegraf</a> is a plugin-driven server agent written by the team at <a href="https://influxdata.com">InfluxData</a> for collecting &amp; reporting metrics. To understand the 
configuration for Mozilla services, please view the documentation in <a href="https://github.com/mozilla-services/cloudops-infra/tree/master/libs/influx/k8s/charts/telegraf">cloudops-infra</a>.</p>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>Configuration is controlled by the following environment variables:</p>
<ul>
<li><code>DJANGO_STATSD_ENABLED</code> (default <code>False</code>) : Enables / disables emitting metrics to a
statsd server</li>
<li><code>STATSD_DEBUG</code> (default <code>False</code>) : Enables / disables metrics logging</li>
<li><code>STATSD_ENABLED</code> (default <code>False</code>) : Enables metrics, <code>True</code> if either
<code>DJANGO_STATSD_ENABLED</code> or <code>STATSD_DEBUG</code> are <code>True</code></li>
<li><code>STATSD_HOST</code> (default <code>&quot;127.0.0.1&quot;</code>) : statsd server IP</li>
<li><code>STATSD_PORT</code> (default <code>8125</code>) : statsd server port</li>
<li><code>STATSD_PREFIX</code> (default <code>&quot;shepherd&quot;</code>) : prefix definition for all metrics in project.
Dashes (and some other values) are converted to periods.</li>
</ul>
<p>With the defaults <code>DJANGO_STATSD_ENABLED=False</code> and <code>STATSD_DEBUG=False</code>, no metrics
are emitted. Ensure that in the deployed production instance of Shepherd, the following values are set accordingly:
<code>DJANGO_STATSD_ENABLED=True</code> and <code>STATSD_DEBUG=False</code>. This is so metrics are emitted but do not appear in logs.</p>
<p>Shepherd runs on k8s, the app is defined in a helm chart that lives in the <code>webservices-infra</code> repo. Environment variables are set in the <code>config</code> dictionary in shepherd's helm chart's values files and rendered into a configmap during deployment. Additionally, secret values (that are mapped to k8s secrets via <code>external-secrets</code>) are set in Google Secret Manager.</p>
<h2 id="development"><a class="header" href="#development">Development</a></h2>
<p>By default, metrics are disabled in development. They must be enabled via an
environment variable or in the <code>.env</code> file. Set <code>STATSD_DEBUG</code> to <code>True</code>.</p>
<p>Metrics are set, incremented, and controlled by utility wrapper methods that are defined in the <code>ShepherdMetrics</code> class contained in the <a href="../consvc_shepherd/utils.py">consvc_shepherd/utils.py</a> module:</p>
<ul>
<li><code>time_if_enabled(name)</code></li>
<li><code>incr_if_enabled(name, value=1, tags=None)</code></li>
<li><code>histogram_if_enabled(name, value, tags=None)</code></li>
<li><code>gauge_if_enabled(name, value, tags=None)</code></li>
</ul>
<p>Simply instantiate a <code>ShepherdMetrics</code> class in your module, passing to it the <code>thing</code> parameter as defined in the <code>markus</code> docs, which defines the prefix keys that will be generated. Generally, <code>thing</code>  should be set to the module name and question, which you can define explicitly or by passing  <code>__name__</code>. Instantiating this class calls <code>markus.get_metrics()</code> and returns <code>markus.main.MetricsInterface</code> under the hood, on which all these methods are called. This metrics class decouples the logic from direct calls to <code>markus.main.MetricsInterface</code> instances.</p>
<pre><code class="language-python">from consvc_shepherd.utils import ShepherdMetrics

metrics = ShepherdMetrics(&quot;shepherd&quot;)

metrics.incr_if_enabled(&quot;publication.success&quot;)
</code></pre>
<p>With <code>DJANGO_STATSD_ENABLED=True</code>, metrics are sent to the server identified by
<code>STATSD_HOST</code> and <code>STATSD_PORT</code>, using the <a href="https://markus.readthedocs.io/en/latest/backends.html#datadog-metrics">DatadogMetrics
backend</a>. These are sent as UDP packets, which means
they are silently dropped if there is no server to receive them. In local
development on macOS, you can emulate a <code>statsd</code> server and see the metrics with:</p>
<pre><code class="language-sh">nc -lu localhost 8125
</code></pre>
<p>With <code>STATSD_DEBUG=True</code>, metrics are sent to the <code>markus</code> log using the
<a href="https://markus.readthedocs.io/en/latest/backends.html#logging-metrics">LoggingMetrics backend</a>. They are displayed along
with other logs like <code>request.summary</code> from that service.</p>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<p>When writing tests for metrics, they can be enabled via
<a href="https://docs.djangoproject.com/en/4.2/topics/testing/tools/#django.test.override_settings">override_settings</a>, and captured for test assertions with
<a href="https://markus.readthedocs.io/en/latest/testing.html">MetricsMock</a>. For example:</p>
<pre><code class="language-python">from django.test import TestCase, override_settings

from markus.testing import MetricsMock

from shepherd.utils import incr_if_enabled


def code_that_emits_metric() -&gt; int:
    incr_if_enabled(&quot;code_called&quot;)
    return 1


class CodeTest(TestCase):
    @override_settings(STATSD_ENABLED=True)
    def test_code(self) -&gt; None:
        with MetricsMock() as mm:
            assert code_that_emits_metric() == 1

        mm.assert_incr_once(&quot;shepherd.code_called&quot;)
</code></pre>
<p>When testing, note that the <code>STATSD_PREFIX</code> (default <code>&quot;shepherd&quot;</code>) is
in the emitted metric name, so in this example, the test is looking for
<code>&quot;shepherd.code_called&quot;</code>, not <code>&quot;code_called&quot;</code>.</p>
<p><code>MetricsMock</code> has other useful helper methods, such as
<a href="https://markus.readthedocs.io/en/latest/testing.html#markus.testing.MetricsMock.print_records">print_records()</a> to see all captured metrics. This can help
when determining what metrics code is emitting.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="quickStart.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="operations/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="quickStart.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="operations/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>


    </body>
</html>
