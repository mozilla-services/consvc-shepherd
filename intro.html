<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Intro - Shepherd</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="intro.html" class="active">Service Overview</a></li><li class="chapter-item affix "><li class="part-title">Docs</li><li class="chapter-item expanded "><a href="intro.html" class="active"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item "><a href="quickStart.html"><strong aria-hidden="true">2.</strong> Quick Start</a></li><li class="chapter-item "><a href="metrics.html"><strong aria-hidden="true">3.</strong> Metrics</a></li><li class="chapter-item "><a href="operations/index.html"><strong aria-hidden="true">4.</strong> Operations and Runbooks</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="operations/auth.html"><strong aria-hidden="true">4.1.</strong> Authentication and Authorization</a></li><li class="chapter-item "><a href="operations/addAdvertisers.html"><strong aria-hidden="true">4.2.</strong> Add Advertisers</a></li><li class="chapter-item "><a href="operations/addAdvertiserPaths.html"><strong aria-hidden="true">4.3.</strong> Add Advertiser Paths</a></li><li class="chapter-item "><a href="operations/addPartners.html"><strong aria-hidden="true">4.4.</strong> Add Partners</a></li><li class="chapter-item "><a href="operations/createSovAllocations.html"><strong aria-hidden="true">4.5.</strong> Create SOV Allocations</a></li><li class="chapter-item "><a href="operations/createPublishSnapshots.html"><strong aria-hidden="true">4.6.</strong> Create and Publish Snapshots</a></li><li class="chapter-item "><a href="operations/rollback.html"><strong aria-hidden="true">4.7.</strong> Rollback</a></li><li class="chapter-item "><a href="operations/recoveryScript.html"><strong aria-hidden="true">4.8.</strong> Recover Snapshot</a></li><li class="chapter-item "><a href="operations/syncBoostrData.html"><strong aria-hidden="true">4.9.</strong> Sync Data from Boostr</a></li><li class="chapter-item "><a href="operations/syncBoostrDataCron.html"><strong aria-hidden="true">4.10.</strong> Sync Data from Boostr Cron Job</a></li><li class="chapter-item "><a href="operations/syncBigQueryData.html"><strong aria-hidden="true">4.11.</strong> Sync Data from BigQuery</a></li><li class="chapter-item "><a href="operations/syncBigQueryDataCron.html"><strong aria-hidden="true">4.12.</strong> Sync Data from BigQuery Cron Job</a></li></ol></li><li class="chapter-item "><li class="part-title">ADR</li><li class="chapter-item "><a href="adr/0000-metrics-client-for-shepherd.html"><strong aria-hidden="true">5.</strong> Shepherd Metrics</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Shepherd</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="contextual-services-shepherd"><a class="header" href="#contextual-services-shepherd">Contextual Services Shepherd</a></h1>
<h2 id="service-overview"><a class="header" href="#service-overview">Service Overview</a></h2>
<p>Shepherd is a Django application that allows users to make changes to Contile's advertising settings without redeploying Contile.
The settings managed here can be changed at runtime, eliminating the need for deployments of the services that use it.</p>
<p>Within Shepherd, users can make changes to Advertising Partners.
A given Partner can have multiple advertisers in numerous geolocations, each with their own distinct domain.
Users can also define partner allocation percentages for each tile position.
This means that given each Contile tile position, you can set the percentage of impressions that will show from each partner.</p>
<p>Once changes have been made and the user is ready to have these changes be effective in production, a user can create a “Snapshot.”
This records the settings and its values at that given point in time in the form of JSON.
Once published, Shepherd uploads a JSON file to Google Cloud Storage.
Contile will then pick up these changes in one of its 5 minute periodic check of the Google Cloud Storage bucket for an updated json file.</p>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<pre class="mermaid">%%{init: {'theme':'dark'}}%%
flowchart
    AdopsUser[\fa:fa-user AdOps User/] --&gt; |Update allocation &amp;&lt;br/&gt;settings snapshots| Shep(Shepherd) --&gt; DB[(Postgres DB)]
    Shep --&gt; |Validated JSON snapshot&lt;br/&gt;sent to GC bucket for access.| GCP[Google Cloud JSON]
    GCP -..- |Periodic sync for&lt;br/&gt;tile information| Contile(Contile)
    Contile --&gt;|API request to get tiles| Firefox{Firefox}
subgraph Firefox[fa:fa-firefox Firefox]
        Tab[New Tab] 
end

Tab --&gt; |Display advertising&lt;br/&gt;tiles in new tab| FirefoxUser[\fa:fa-user Firefox User/]
FirefoxUser[\fa:fa-user Firefox User/]
</pre>
<h2 id="datastores"><a class="header" href="#datastores">Datastores</a></h2>
<p>Shepherd's main datastore is a Postgres database that stores all partners, advertisers and snapshots.</p>
<p>All snapshots are uploaded as a JSON file to a Google Cloud bucket.
A pre-defined JSON schema validates the snapshot output prior to sending the snapshot to Google Cloud.
From there, Contile accesses the settings from the uploaded JSON file to serve Firefox users the correct advertising tiles in each new tab.</p>
<h2 id="logging"><a class="header" href="#logging">Logging</a></h2>
<p>All non-sentry logs are formatted using the <a href="https://python-dockerflow.readthedocs.io/en/main/api/logging.html">python-dockerflow JSON Formatter</a>. As a result, all JSON logs emitted will follow the MozLog JSON Schema. Schema details can be found <a href="https://wiki.mozilla.org/Firefox/Services/Logging">here.</a>.</p>
<h2 id="shepherd-service-urls"><a class="header" href="#shepherd-service-urls">Shepherd Service URLs:</a></h2>
<p>Stage: https://shepherd.stage.ads.nonprod.webservices.mozgcp.net/admin/</p>
<p>Prod: https://shepherd.services.mozilla.com/admin/</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="intro.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="intro.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>


    </body>
</html>
