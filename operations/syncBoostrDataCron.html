<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Sync Data from Boostr Cron Job - Shepherd</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../intro.html">Service Overview</a></li><li class="chapter-item affix "><li class="part-title">Docs</li><li class="chapter-item "><a href="../quickStart.html"><strong aria-hidden="true">1.</strong> Quick Start</a></li><li class="chapter-item "><a href="../metrics.html"><strong aria-hidden="true">2.</strong> Metrics</a></li><li class="chapter-item expanded "><a href="../operations/index.html"><strong aria-hidden="true">3.</strong> Operations and Runbooks</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operations/auth.html"><strong aria-hidden="true">3.1.</strong> Authentication and Authorization</a></li><li class="chapter-item "><a href="../operations/addAdvertisers.html"><strong aria-hidden="true">3.2.</strong> Add Advertisers</a></li><li class="chapter-item "><a href="../operations/addAdvertiserPaths.html"><strong aria-hidden="true">3.3.</strong> Add Advertiser Paths</a></li><li class="chapter-item "><a href="../operations/addPartners.html"><strong aria-hidden="true">3.4.</strong> Add Partners</a></li><li class="chapter-item "><a href="../operations/createSovAllocations.html"><strong aria-hidden="true">3.5.</strong> Create SOV Allocations</a></li><li class="chapter-item "><a href="../operations/createPublishSnapshots.html"><strong aria-hidden="true">3.6.</strong> Create and Publish Snapshots</a></li><li class="chapter-item "><a href="../operations/rollback.html"><strong aria-hidden="true">3.7.</strong> Rollback</a></li><li class="chapter-item "><a href="../operations/recoveryScript.html"><strong aria-hidden="true">3.8.</strong> Recover Snapshot</a></li><li class="chapter-item "><a href="../operations/syncBoostrData.html"><strong aria-hidden="true">3.9.</strong> Sync Data from Boostr</a></li><li class="chapter-item expanded "><a href="../operations/syncBoostrDataCron.html" class="active"><strong aria-hidden="true">3.10.</strong> Sync Data from Boostr Cron Job</a></li></ol></li><li class="chapter-item "><li class="part-title">ADR</li><li class="chapter-item "><a href="../adr/0000-metrics-client-for-shepherd.html"><strong aria-hidden="true">4.</strong> Shepherd Metrics</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Shepherd</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="boostr-data-sync-cron"><a class="header" href="#boostr-data-sync-cron">Boostr Data Sync Cron</a></h1>
<p>The Boostr data sync process documented in the <a href="syncBoostrData.html">SyncBoostrData.md</a> document is orchestrated by a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/">Kubernetetes Cronjob</a> that is maintained in the <a href="https://github.com/mozilla-it/webservices-infra/tree/main/ads/k8s/shepherd">shepherd chart</a> in the <a href="https://github.com/mozilla-it/webservices-infra/tree/main">webservices-infra</a> repo. </p>
<h3 id="how-it-runs"><a class="header" href="#how-it-runs">How it runs</a></h3>
<p>The CronJob spins up a new pod on a configurable schedule using the latest container image of the Shepherd application. It then triggers the 
<a href="consvc_shepherd/management/commands/sync_boostr_data.py">sync_boostr_data.py</a> script within the pod. Refer to <a href="syncBoostrDataCron.html">SyncBoostrData.md</a> to understand more about the inner workings of the script.</p>
<h3 id="a-note-on-secrets"><a class="header" href="#a-note-on-secrets">A Note on Secrets</a></h3>
<p>Secrets such as the email and password used to access the Boostr API are stored in 1Pass. However, since k8s cronjobs are ultimately k8s pods running a container image, we follow best practices and mount environment variables and secrets to the resulting pods via k8s configmaps &amp; secrets. In this context, non-sensitive key-value pairs are deployed using a configmap (defined in the [shepherd chart]'s values files), sensitive values are deployed using a secret (secrets are defined in Google Secret Manager secrets in tenant projects and synced into tenant namespaces using the <code>external-secrets operator</code>, see <a href="https://mozilla-hub.atlassian.net/wiki/x/cQaqAQ">here</a> for more details).</p>
<p>The process SRE has recommended for storing/using secrets is as follows:</p>
<ol>
<li>Secrets should be stored in 1password for use by individuals (e.g. the dev team)</li>
<li>GCPv2 tenant projects make use of Google Secret Manager to distribute secrets to deployments. Helm charts that are deployed to tenant namespaces should define an external-secret that syncs secret data down to k8s secrets from Google Secret Manager Secrets. <a href="https://mozilla-hub.atlassian.net/wiki/x/cQaqAQ">see</a></li>
<li>Tenant developers &amp; admins can update Google Secret Manager secrets as necessary. Please follow the process defined in the previous step to do so.</li>
<li>As a result of the above, the values for the secret variables in #2 are set and available in the resource (pod / container) as environment variables.</li>
</ol>
<h3 id="debugging-troubleshooting-and-viewing-logs"><a class="header" href="#debugging-troubleshooting-and-viewing-logs">Debugging, troubleshooting and viewing logs</a></h3>
<p>To view logs, use Logs Explorer. All GKE pod logs are forwarded to tenant projects for tenant viewers, developers and admins to look at. To filter for boostr data sync's logs explicitly, set the following filter:</p>
<pre><code>labels.&quot;k8s-pod/app_kubernetes_io/component&quot; =~ &quot;^shepherd-cron-boostr-sync&quot;
</code></pre>
<p>The following links should lead to the right place:</p>
<ul>
<li><a href="https://cloudlogging.app.goo.gl/VPZZgGHdFPvzVBzB7">prod/prod</a></li>
<li><a href="https://cloudlogging.app.goo.gl/qT3JmY6bcLw54Cwi9">nonprod/stage</a></li>
</ul>
<p>As an alternative, <code>gcloud logging read</code> can be used to retrieve logs via the CLI (follow <a href="https://cloud.google.com/sdk/gcloud/reference/logging/read">this guide</a>, to get more details). It is possible to retrieve logs via <code>kubectl</code> as well, setup requires some additional steps, though, since we're running on private clusters that need to be accessed via jumphosts(more info can be found <a href="https://mozilla-hub.atlassian.net/wiki/x/TAiqAQ">here</a>).</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../operations/syncBoostrData.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../adr/0000-metrics-client-for-shepherd.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../operations/syncBoostrData.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../adr/0000-metrics-client-for-shepherd.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </body>
</html>
